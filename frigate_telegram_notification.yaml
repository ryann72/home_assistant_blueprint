blueprint:
  name: Frigate - Notification Telegram
  description: Notifications Frigate via Telegram (nouvelle syntaxe notify)
  domain: automation

  input:
    camera:
      name: CamÃ©ra Frigate
      description: Nom de la camÃ©ra dans Frigate

    target_notify:
      name: EntitÃ© Telegram
      description: >
        EntitÃ© notify Telegram (ex: notify.telegram_123456789)
      selector:
        entity:
          domain: notify

    notification:
      name: DÃ©sactiver la notification
      description: true = silencieux / false = normal
      selector:
        select:
          options:
            - 'true'
            - 'false'
      default: 'false'

    notification_text:
      name: (Optionnel) Texte de la notification
      description: Texte personnalisÃ© de la notification Telegram
      default: ''
      selector:
        text:

    base_url:
      name: (Optionnel) URL de base
      default: ''

    zone_filter:
      name: (Optionnel) Filtre par zone
      default: false
      selector:
        boolean: {}

    zones:
      name: (Optionnel) Zones Frigate
      default: []
      selector:
        object: {}

    labels:
      name: (Optionnel) Objets Frigate
      default: []
      selector:
        object: {}

    presence_filter:
      name: (Optionnel) Filtre de prÃ©sence
      default: ''
      selector:
        entity: {}

mode: single
max_exceeded: silent

trigger:
  platform: mqtt
  topic: frigate/events
  payload: !input camera
  value_template: "{{ value_json.after.camera }}"

variables:
  id: "{{ trigger.payload_json.after.id }}"
  camera: "{{ trigger.payload_json.after.camera }}"
  camera_name: "{{ camera | replace('_', ' ') | title }}"
  object: "{{ trigger.payload_json.after.label }}"
  label: "{{ object | title }}"
  entered_zones: "{{ trigger.payload_json.after.entered_zones }}"
  type: "{{ trigger.payload_json.type }}"
  notify_entity: !input target_notify
  base_url: !input base_url
  zone_only: !input zone_filter
  zones: "{{ ( !input zones ) | list }}"
  labels: "{{ ( !input labels ) | list }}"
  presence_entity: !input presence_filter
  notification: !input notification
  notification_text: !input notification_text

  notif_text: >
    {{ notification_text
       if notification_text | length > 0
       else 'ðŸš¨ Mouvement dÃ©tectÃ© â€” CamÃ©ra : ' ~ camera_name ~ ' (Objet : ' ~ label ~ ')' }}

condition:
  - "{{ type != 'end' }}"
  - "{{ not zone_only or entered_zones | length > 0 }}"
  - "{{ not zones | length or zones | select('in', entered_zones) | list | length > 0 }}"
  - "{{ not labels | length or object in labels }}"
  - "{{ not presence_entity or not is_state(presence_entity, 'home') }}"

action:
  # ðŸ“¸ Snapshot
  - service: notify.send_message
    target:
      entity_id: "{{ notify_entity }}"
    data:
      message: "{{ notif_text }}"
      disable_notification: "{{ notification }}"
      photo:
        - url: "{{ base_url }}/api/frigate/notifications/{{ id }}/snapshot.jpg"

  # ðŸŽ¥ Clip vidÃ©o
  - repeat:
      sequence:
        - wait_for_trigger:
            - platform: mqtt
              topic: frigate/events
              payload: "{{ id }}"
              value_template: "{{ value_json.after.id }}"
          timeout:
            minutes: 2
          continue_on_timeout: false

        - condition: template
          value_template: "{{ wait.trigger.payload_json.type == 'end' }}"

        - service: notify.send_message
          target:
            entity_id: "{{ notify_entity }}"
          data:
            message: "{{ notif_text }}"
            disable_notification: "{{ notification }}"
            video:
              - url: "{{ base_url }}/api/frigate/notifications/{{ id }}/{{ camera }}/clip.mp4"

      until: "{{ wait.trigger.payload_json.type == 'end' }}"
