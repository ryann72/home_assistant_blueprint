blueprint:
  name: "Frigate - Notification Telegram (nouvelle syntaxe)"
  description: "Notifications Frigate (snapshot + clip) via Telegram avec notify.send_message"
  domain: automation

  input:
    camera:
      name: "CamÃ©ra Frigate"
      description: "Nom de la camÃ©ra dans Frigate (/config.yml)"

    target_notify:
      name: "EntitÃ© Telegram"
      description: "EntitÃ© notify Telegram (ex: notify.telegram_123456789)"
      selector:
        entity:
          domain: notify

    notification_text:
      name: "(Optionnel) Texte de la notification"
      description: "Texte personnalisÃ© pour la notification Telegram"
      default: ""
      selector:
        text:

    base_url:
      name: "(Optionnel) URL de base"
      description: "URL externe de Home Assistant"
      default: ""

    zone_filter:
      name: "(Optionnel) Filtre par zone"
      description: "Notifie uniquement si une zone est franchie"
      default: false
      selector:
        boolean: {}

    zones:
      name: "(Optionnel) Zones Frigate"
      description: "Liste de zones Ã  surveiller"
      default: []
      selector:
        object: {}

    labels:
      name: "(Optionnel) Objets Frigate"
      description: "Liste dâ€™objets Ã  surveiller (person, car, etc.)"
      default: []
      selector:
        object: {}

    presence_filter:
      name: "(Optionnel) Filtre de prÃ©sence"
      description: "Notifie uniquement si lâ€™entitÃ© nâ€™est pas Ã  la maison"
      default: ""
      selector:
        entity: {}

mode: single
max_exceeded: silent

trigger:
  platform: mqtt
  topic: frigate/events
  payload: !input camera
  value_template: "{{ value_json.after.camera }}"

variables:
  id: "{{ trigger.payload_json.after.id }}"
  camera: "{{ trigger.payload_json.after.camera }}"
  camera_name: "{{ camera | replace('_', ' ') | title }}"

  # Label brut et formatÃ©
  object: "{{ trigger.payload_json.after.label | lower }}"
  label: "{{ trigger.payload_json.after.label | title }}"

  entered_zones: "{{ trigger.payload_json.after.entered_zones }}"
  type: "{{ trigger.payload_json.type }}"

  # Telegram
  notify_entity: !input target_notify

  # URL de base
  base_url: !input base_url

  # Zones
  zone_only: !input zone_filter
  input_zones: !input zones
  zones: "{{ input_zones | default([]) }}"

  # Labels
  input_labels: !input labels
  labels: "{{ input_labels | map('lower') | list }}"

  # PrÃ©sence
  presence_entity: !input presence_filter

  # Texte de notification final
  notif_text: >
    {{ notification_text
       if notification_text | length > 0
       else 'ðŸš¨ Mouvement dÃ©tectÃ© â€” CamÃ©ra : ' ~ camera_name ~ ' (Objet : ' ~ label ~ ')' }}

condition:
  - "{{ not zone_only or entered_zones | length > 0 }}"
  - "{{ zones | length == 0 or (entered_zones | select('in', zones) | list | length > 0) }}"
  - "{{ labels | length == 0 or object in labels }}"
  - "{{ not presence_entity or not is_state(presence_entity, 'home') }}"

action:
  - action: "{{ notify_entity }}"
    data:
      title: "ðŸ“¸ Snapshot Frigate"
      message: "{{ notif_text }}"
      photo:
        - url: "{{ base_url }}/api/frigate/notifications/{{ id }}/snapshot.jpg"
          caption: "CamÃ©ra : {{ camera_name }} (Objet : {{ label }})"


  # Envoi du clip vidÃ©o Ã  la fin
   - repeat:
      sequence:
        - wait_for_trigger:
            - platform: mqtt
              topic: frigate/events
              payload: "{{ id }}"
              value_template: "{{ value_json.after.id }}"
          timeout:
            minutes: 2
          continue_on_timeout: false

        - condition: template
          value_template: "{{ wait.trigger.payload_json.type == 'end' }}"

        - action: "{{ notify_entity }}"
          data:
            title: "ðŸŽ¬ Clip Frigate"
            message: "{{ notif_text }}"
            video:
              - url: "{{ base_url }}/api/frigate/notifications/{{ id }}/{{ camera }}/clip.mp4"
                caption: "CamÃ©ra : {{ camera_name }} (Objet : {{ label }})"

      until: "{{ wait.trigger.payload_json.type == 'end' }}"
